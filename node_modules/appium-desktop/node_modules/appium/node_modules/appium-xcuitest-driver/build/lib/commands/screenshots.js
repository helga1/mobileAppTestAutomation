"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

var _nodeSimctl = require("node-simctl");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

let commands = {};

async function getScreenshotWithIdevicelib(udid, isLandscape) {
  const pathToScreenshotTiff = await _appiumSupport.tempDir.path({
    prefix: `screenshot-${udid}`,
    suffix: '.tiff'
  });
  await _appiumSupport.fs.rimraf(pathToScreenshotTiff);
  const pathToResultPng = await _appiumSupport.tempDir.path({
    prefix: `screenshot-${udid}`,
    suffix: '.png'
  });
  await _appiumSupport.fs.rimraf(pathToResultPng);

  try {
    try {
      await (0, _teen_process.exec)('idevicescreenshot', ['-u', udid, pathToScreenshotTiff]);
    } catch (e) {
      throw new Error(`Cannot take a screenshot from the device '${udid}' using ` + `idevicescreenshot. Original error: ${e.message}`);
    }

    let sipsArgs = ['-s', 'format', 'png', pathToScreenshotTiff, '--out', pathToResultPng];

    if (isLandscape) {
      sipsArgs = ['-r', '-90', ...sipsArgs];
    }

    try {
      await (0, _teen_process.exec)('sips', sipsArgs);
    } catch (e) {
      throw new Error(`Cannot convert a screenshot from TIFF to PNG using sips tool. ` + `Original error: ${e.message}`);
    }

    if (!(await _appiumSupport.fs.exists(pathToResultPng))) {
      throw new Error(`Cannot convert a screenshot from TIFF to PNG. The conversion ` + `result does not exist at '${pathToResultPng}'`);
    }

    return (await _appiumSupport.fs.readFile(pathToResultPng)).toString('base64');
  } finally {
    await _appiumSupport.fs.rimraf(pathToScreenshotTiff);
    await _appiumSupport.fs.rimraf(pathToResultPng);
  }
}

async function verifyIdeviceScreenshotAvailable() {
  try {
    await _appiumSupport.fs.which('idevicescreenshot');
  } catch (err) {
    throw new Error(`No 'idevicescreenshot' program found. To use, install ` + `using 'brew install --HEAD libimobiledevice'`);
  }
}

commands.getScreenshot = async function getScreenshot() {
  const getScreenshotFromIDS = async () => {
    _logger.default.debug(`Taking screenshot with 'idevicescreenshot'`);

    await verifyIdeviceScreenshotAvailable();
    const orientation = await this.proxyCommand('/orientation', 'GET');
    return await getScreenshotWithIdevicelib(this.opts.udid, orientation === 'LANDSCAPE');
  };

  const getScreenshotFromWDA = async () => {
    _logger.default.debug(`Taking screenshot with WDA`);

    const data = await this.proxyCommand('/screenshot', 'GET');

    if (!_lodash.default.isString(data)) {
      throw new Error(`Unable to take screenshot. WDA returned '${JSON.stringify(data)}'`);
    }

    return data;
  };

  if (this.opts.realDeviceScreenshotter && this.mjpegStream) {
    _logger.default.warn("You've specified screenshot retrieval via both MJpeg server " + 'and a real device screenshot utility. Please use one or the ' + 'other! Choosing MJPEG server');
  }

  if (this.mjpegStrem) {
    const data = await this.mjpegStream.lastChunkPNGBase64();

    if (data) {
      return data;
    }

    _logger.default.warn('Tried to get screenshot from active MJPEG stream, but there ' + 'was no data yet. Falling back to regular screenshot methods.');
  }

  const useIdeviceScreenshot = _lodash.default.lowerCase(this.opts.realDeviceScreenshotter) === 'idevicescreenshot';

  if (useIdeviceScreenshot) {
    return await getScreenshotFromIDS();
  }

  try {
    return await getScreenshotFromWDA();
  } catch (err) {
    _logger.default.warn(`Error getting screenshot: ${err.message}`);
  }

  if (this.isSimulator()) {
    _logger.default.info(`Falling back to 'simctl io screenshot' API`);

    return await (0, _nodeSimctl.getScreenshot)(this.opts.udid);
  }

  try {
    return await getScreenshotFromIDS();
  } catch (err) {
    _logger.default.warn(`Error getting screenshot through 'idevicescreenshot': ${err.message}`);
  }

  return await (0, _asyncbox.retryInterval)(2, 1000, getScreenshotFromWDA);
};

commands.getElementScreenshot = async function getElementScreenshot(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    const atomsElement = this.useAtomsElement(el);
    return await this.executeAtom('getElementScreenshot', [atomsElement]);
  }

  const data = await this.proxyCommand(`/element/${el}/screenshot`, 'GET');

  if (!_lodash.default.isString(data)) {
    _logger.default.errorAndThrow(`Unable to take a screenshot of the element ${el}. WDA returned '${JSON.stringify(data)}'`);
  }

  return data;
};

commands.getViewportScreenshot = async function getViewportScreenshot() {
  let statusBarHeight = await this.getStatusBarHeight();
  const screenshot = await this.getScreenshot();

  if (statusBarHeight === 0) {
    return screenshot;
  }

  const scale = await this.getDevicePixelRatio();
  statusBarHeight = Math.round(statusBarHeight * scale);
  const windowSize = await this.getWindowSize();
  let rect = {
    left: 0,
    top: statusBarHeight,
    width: windowSize.width * scale,
    height: windowSize.height * scale - statusBarHeight
  };
  let newScreenshot = await _appiumSupport.imageUtil.cropBase64Image(screenshot, rect);
  return newScreenshot;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zY3JlZW5zaG90cy5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImdldFNjcmVlbnNob3RXaXRoSWRldmljZWxpYiIsInVkaWQiLCJpc0xhbmRzY2FwZSIsInBhdGhUb1NjcmVlbnNob3RUaWZmIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJzdWZmaXgiLCJmcyIsInJpbXJhZiIsInBhdGhUb1Jlc3VsdFBuZyIsImUiLCJFcnJvciIsIm1lc3NhZ2UiLCJzaXBzQXJncyIsImV4aXN0cyIsInJlYWRGaWxlIiwidG9TdHJpbmciLCJ2ZXJpZnlJZGV2aWNlU2NyZWVuc2hvdEF2YWlsYWJsZSIsIndoaWNoIiwiZXJyIiwiZ2V0U2NyZWVuc2hvdCIsImdldFNjcmVlbnNob3RGcm9tSURTIiwibG9nIiwiZGVidWciLCJvcmllbnRhdGlvbiIsInByb3h5Q29tbWFuZCIsIm9wdHMiLCJnZXRTY3JlZW5zaG90RnJvbVdEQSIsImRhdGEiLCJfIiwiaXNTdHJpbmciLCJKU09OIiwic3RyaW5naWZ5IiwicmVhbERldmljZVNjcmVlbnNob3R0ZXIiLCJtanBlZ1N0cmVhbSIsIndhcm4iLCJtanBlZ1N0cmVtIiwibGFzdENodW5rUE5HQmFzZTY0IiwidXNlSWRldmljZVNjcmVlbnNob3QiLCJsb3dlckNhc2UiLCJpc1NpbXVsYXRvciIsImluZm8iLCJnZXRFbGVtZW50U2NyZWVuc2hvdCIsImVsIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJpc1dlYkNvbnRleHQiLCJhdG9tc0VsZW1lbnQiLCJ1c2VBdG9tc0VsZW1lbnQiLCJleGVjdXRlQXRvbSIsImVycm9yQW5kVGhyb3ciLCJnZXRWaWV3cG9ydFNjcmVlbnNob3QiLCJzdGF0dXNCYXJIZWlnaHQiLCJnZXRTdGF0dXNCYXJIZWlnaHQiLCJzY3JlZW5zaG90Iiwic2NhbGUiLCJnZXREZXZpY2VQaXhlbFJhdGlvIiwiTWF0aCIsInJvdW5kIiwid2luZG93U2l6ZSIsImdldFdpbmRvd1NpemUiLCJyZWN0IiwibGVmdCIsInRvcCIsIndpZHRoIiwiaGVpZ2h0IiwibmV3U2NyZWVuc2hvdCIsImltYWdlVXRpbCIsImNyb3BCYXNlNjRJbWFnZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjs7QUFFQSxlQUFlQywyQkFBZixDQUE0Q0MsSUFBNUMsRUFBa0RDLFdBQWxELEVBQStEO0FBQzdELFFBQU1DLG9CQUFvQixHQUFHLE1BQU1DLHVCQUFRQyxJQUFSLENBQWE7QUFBQ0MsSUFBQUEsTUFBTSxFQUFHLGNBQWFMLElBQUssRUFBNUI7QUFBK0JNLElBQUFBLE1BQU0sRUFBRTtBQUF2QyxHQUFiLENBQW5DO0FBQ0EsUUFBTUMsa0JBQUdDLE1BQUgsQ0FBVU4sb0JBQVYsQ0FBTjtBQUNBLFFBQU1PLGVBQWUsR0FBRyxNQUFNTix1QkFBUUMsSUFBUixDQUFhO0FBQUNDLElBQUFBLE1BQU0sRUFBRyxjQUFhTCxJQUFLLEVBQTVCO0FBQStCTSxJQUFBQSxNQUFNLEVBQUU7QUFBdkMsR0FBYixDQUE5QjtBQUNBLFFBQU1DLGtCQUFHQyxNQUFILENBQVVDLGVBQVYsQ0FBTjs7QUFDQSxNQUFJO0FBQ0YsUUFBSTtBQUNGLFlBQU0sd0JBQUssbUJBQUwsRUFBMEIsQ0FBQyxJQUFELEVBQU9ULElBQVAsRUFBYUUsb0JBQWIsQ0FBMUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPUSxDQUFQLEVBQVU7QUFDVixZQUFNLElBQUlDLEtBQUosQ0FBVyw2Q0FBNENYLElBQUssVUFBbEQsR0FDYixzQ0FBcUNVLENBQUMsQ0FBQ0UsT0FBUSxFQUQ1QyxDQUFOO0FBRUQ7O0FBQ0QsUUFBSUMsUUFBUSxHQUFHLENBQUMsSUFBRCxFQUFPLFFBQVAsRUFBaUIsS0FBakIsRUFBd0JYLG9CQUF4QixFQUE4QyxPQUE5QyxFQUF1RE8sZUFBdkQsQ0FBZjs7QUFDQSxRQUFJUixXQUFKLEVBQWlCO0FBQ2ZZLE1BQUFBLFFBQVEsR0FB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cUJBQWYsR0FBd0M7QUFDdkUsTUFBSUMsZUFBZSxHQUFHLE1BQU0sS0FBS0Msa0JBQUwsRUFBNUI7QUFDQSxRQUFNQyxVQUFVLEdBQUcsTUFBTSxLQUFLbEMsYUFBTCxFQUF6Qjs7QUFJQSxNQUFJZ0MsZUFBZSxLQUFLLENBQXhCLEVBQTJCO0FBQ3pCLFdBQU9FLFVBQVA7QUFDRDs7QUFFRCxRQUFNQyxLQUFLLEdBQUcsTUFBTSxLQUFLQyxtQkFBTCxFQUFwQjtBQUVBSixFQUFBQSxlQUFlLEdBQUdLLElBQUksQ0FBQ0MsS0FBTCxDQUFXTixlQUFlLEdBQUdHLEtBQTdCLENBQWxCO0FBQ0EsUUFBTUksVUFBVSxHQUFHLE1BQU0sS0FBS0MsYUFBTCxFQUF6QjtBQUNBLE1BQUlDLElBQUksR0FBRztBQUNUQyxJQUFBQSxJQUFJLEVBQUUsQ0FERztBQUVUQyxJQUFBQSxHQUFHLEVBQUVYLGVBRkk7QUFHVFksSUFBQUEsS0FBSyxFQUFFTCxVQUFVLENBQUNLLEtBQVgsR0FBbUJULEtBSGpCO0FBSVRVLElBQUFBLE1BQU0sRUFBSU4sVUFBVSxDQUFDTSxNQUFYLEdBQW9CVixLQUFyQixHQUE4Qkg7QUFKOUIsR0FBWDtBQU1BLE1BQUljLGFBQWEsR0FBRyxNQUFNQyx5QkFBVUMsZUFBVixDQUEwQmQsVUFBMUIsRUFBc0NPLElBQXRDLENBQTFCO0FBQ0EsU0FBT0ssYUFBUDtBQUNELENBdEJEOztlQXdCZXBFLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGdldFNjcmVlbnNob3QgYXMgc2ltY3RsR2V0U2NyZWVuc2hvdCB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIsIHV0aWwsIGltYWdlVXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxubGV0IGNvbW1hbmRzID0ge307XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbnNob3RXaXRoSWRldmljZWxpYiAodWRpZCwgaXNMYW5kc2NhcGUpIHtcbiAgY29uc3QgcGF0aFRvU2NyZWVuc2hvdFRpZmYgPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe3ByZWZpeDogYHNjcmVlbnNob3QtJHt1ZGlkfWAsIHN1ZmZpeDogJy50aWZmJ30pO1xuICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvU2NyZWVuc2hvdFRpZmYpO1xuICBjb25zdCBwYXRoVG9SZXN1bHRQbmcgPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe3ByZWZpeDogYHNjcmVlbnNob3QtJHt1ZGlkfWAsIHN1ZmZpeDogJy5wbmcnfSk7XG4gIGF3YWl0IGZzLnJpbXJhZihwYXRoVG9SZXN1bHRQbmcpO1xuICB0cnkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKCdpZGV2aWNlc2NyZWVuc2hvdCcsIFsnLXUnLCB1ZGlkLCBwYXRoVG9TY3JlZW5zaG90VGlmZl0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHRha2UgYSBzY3JlZW5zaG90IGZyb20gdGhlIGRldmljZSAnJHt1ZGlkfScgdXNpbmcgYCArXG4gICAgICAgIGBpZGV2aWNlc2NyZWVuc2hvdC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgICBsZXQgc2lwc0FyZ3MgPSBbJy1zJywgJ2Zvcm1hdCcsICdwbmcnLCBwYXRoVG9TY3JlZW5zaG90VGlmZiwgJy0tb3V0JywgcGF0aFRvUmVzdWx0UG5nXTtcbiAgICBpZiAoaXNMYW5kc2NhcGUpIHtcbiAgICAgIHNpcHNBcmdzID0gWyctcicsICctOTAnLCAuLi5zaXBzQXJnc107XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICAvLyBUaGUgc2lwcyB0b29sIGlzIG9ubHkgcHJlc2VudCBvbiBNYWMgT1NcbiAgICAgIGF3YWl0IGV4ZWMoJ3NpcHMnLCBzaXBzQXJncyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29udmVydCBhIHNjcmVlbnNob3QgZnJvbSBUSUZGIHRvIFBORyB1c2luZyBzaXBzIHRvb2wuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYXRoVG9SZXN1bHRQbmcpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBjb252ZXJ0IGEgc2NyZWVuc2hvdCBmcm9tIFRJRkYgdG8gUE5HLiBUaGUgY29udmVyc2lvbiBgICtcbiAgICAgICAgYHJlc3VsdCBkb2VzIG5vdCBleGlzdCBhdCAnJHtwYXRoVG9SZXN1bHRQbmd9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gKGF3YWl0IGZzLnJlYWRGaWxlKHBhdGhUb1Jlc3VsdFBuZykpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvU2NyZWVuc2hvdFRpZmYpO1xuICAgIGF3YWl0IGZzLnJpbXJhZihwYXRoVG9SZXN1bHRQbmcpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHZlcmlmeUlkZXZpY2VTY3JlZW5zaG90QXZhaWxhYmxlICgpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53aGljaCgnaWRldmljZXNjcmVlbnNob3QnKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBObyAnaWRldmljZXNjcmVlbnNob3QnIHByb2dyYW0gZm91bmQuIFRvIHVzZSwgaW5zdGFsbCBgICtcbiAgICAgICAgICAgICAgICAgICAgYHVzaW5nICdicmV3IGluc3RhbGwgLS1IRUFEIGxpYmltb2JpbGVkZXZpY2UnYCk7XG4gIH1cbn1cblxuY29tbWFuZHMuZ2V0U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbnNob3QgKCkge1xuICBjb25zdCBnZXRTY3JlZW5zaG90RnJvbUlEUyA9IGFzeW5jICgpID0+IHtcbiAgICBsb2cuZGVidWcoYFRha2luZyBzY3JlZW5zaG90IHdpdGggJ2lkZXZpY2VzY3JlZW5zaG90J2ApO1xuICAgIGF3YWl0IHZlcmlmeUlkZXZpY2VTY3JlZW5zaG90QXZhaWxhYmxlKCk7XG4gICAgY29uc3Qgb3JpZW50YXRpb24gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL29yaWVudGF0aW9uJywgJ0dFVCcpO1xuICAgIHJldHVybiBhd2FpdCBnZXRTY3JlZW5zaG90V2l0aElkZXZpY2VsaWIodGhpcy5vcHRzLnVkaWQsIG9yaWVudGF0aW9uID09PSAnTEFORFNDQVBFJyk7XG4gIH07XG5cbiAgY29uc3QgZ2V0U2NyZWVuc2hvdEZyb21XREEgPSBhc3luYyAoKSA9PiB7XG4gICAgbG9nLmRlYnVnKGBUYWtpbmcgc2NyZWVuc2hvdCB3aXRoIFdEQWApO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3NjcmVlbnNob3QnLCAnR0VUJyk7XG4gICAgaWYgKCFfLmlzU3RyaW5nKGRhdGEpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byB0YWtlIHNjcmVlbnNob3QuIFdEQSByZXR1cm5lZCAnJHtKU09OLnN0cmluZ2lmeShkYXRhKX0nYCk7XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIC8vIGVuc3VyZSB0aGUgdXNlciBkb2Vzbid0IHRyeSB0byB1c2UgMiBzcGVjaWFsdHkgc2NyZWVuc2hvdCBjYXBzXG4gIGlmICh0aGlzLm9wdHMucmVhbERldmljZVNjcmVlbnNob3R0ZXIgJiYgdGhpcy5tanBlZ1N0cmVhbSkge1xuICAgIGxvZy53YXJuKFwiWW91J3ZlIHNwZWNpZmllZCBzY3JlZW5zaG90IHJldHJpZXZhbCB2aWEgYm90aCBNSnBlZyBzZXJ2ZXIgXCIgK1xuICAgICAgICAgICAgICdhbmQgYSByZWFsIGRldmljZSBzY3JlZW5zaG90IHV0aWxpdHkuIFBsZWFzZSB1c2Ugb25lIG9yIHRoZSAnICtcbiAgICAgICAgICAgICAnb3RoZXIhIENob29zaW5nIE1KUEVHIHNlcnZlcicpO1xuICB9XG5cbiAgLy8gaWYgd2UndmUgc3BlY2lmaWVkIGFuIG1qcGVnIHNlcnZlciwgdXNlIHRoYXRcbiAgaWYgKHRoaXMubWpwZWdTdHJlbSkge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLm1qcGVnU3RyZWFtLmxhc3RDaHVua1BOR0Jhc2U2NCgpO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgbG9nLndhcm4oJ1RyaWVkIHRvIGdldCBzY3JlZW5zaG90IGZyb20gYWN0aXZlIE1KUEVHIHN0cmVhbSwgYnV0IHRoZXJlICcgK1xuICAgICAgICAgICAgICd3YXMgbm8gZGF0YSB5ZXQuIEZhbGxpbmcgYmFjayB0byByZWd1bGFyIHNjcmVlbnNob3QgbWV0aG9kcy4nKTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSB1c2UgdGhlIHJlYWwgZGV2aWNlIHNjcmVlbnNob3R0ZXIgYXMgc3BlY2lmaWVkXG4gIGNvbnN0IHVzZUlkZXZpY2VTY3JlZW5zaG90ID0gXy5sb3dlckNhc2UodGhpcy5vcHRzLnJlYWxEZXZpY2VTY3JlZW5zaG90dGVyKSA9PT0gJ2lkZXZpY2VzY3JlZW5zaG90JztcbiAgaWYgKHVzZUlkZXZpY2VTY3JlZW5zaG90KSB7XG4gICAgcmV0dXJuIGF3YWl0IGdldFNjcmVlbnNob3RGcm9tSURTKCk7XG4gIH1cblxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBnZXRTY3JlZW5zaG90RnJvbVdEQSgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgRXJyb3IgZ2V0dGluZyBzY3JlZW5zaG90OiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG5cbiAgLy8gc2ltdWxhdG9yIGF0dGVtcHRcbiAgaWYgKHRoaXMuaXNTaW11bGF0b3IoKSkge1xuICAgIGxvZy5pbmZvKGBGYWxsaW5nIGJhY2sgdG8gJ3NpbWN0bCBpbyBzY3JlZW5zaG90JyBBUElgKTtcbiAgICByZXR1cm4gYXdhaXQgc2ltY3RsR2V0U2NyZWVuc2hvdCh0aGlzLm9wdHMudWRpZCk7XG4gIH1cblxuICAvLyBhbGwgc2ltdWxhdG9yIHNjZW5hcmlvcyBhcmUgZmluaXNoZWRcbiAgLy8gcmVhbCBkZXZpY2UsIHNvIHRyeSBpZGV2aWNlc2NyZWVuc2hvdCBpZiBwb3NzaWJsZVxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBnZXRTY3JlZW5zaG90RnJvbUlEUygpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgRXJyb3IgZ2V0dGluZyBzY3JlZW5zaG90IHRocm91Z2ggJ2lkZXZpY2VzY3JlZW5zaG90JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIFJldHJ5IGZvciByZWFsIGRldmljZXMgb25seS4gRmFpbCBmYXN0IG9uIFNpbXVsYXRvciBpZiBzaW1jdGwgZG9lcyBub3Qgd29yayBhcyBleHBlY3RlZFxuICByZXR1cm4gYXdhaXQgcmV0cnlJbnRlcnZhbCgyLCAxMDAwLCBnZXRTY3JlZW5zaG90RnJvbVdEQSk7XG59O1xuXG5jb21tYW5kcy5nZXRFbGVtZW50U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uIGdldEVsZW1lbnRTY3JlZW5zaG90IChlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgY29uc3QgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRFbGVtZW50U2NyZWVuc2hvdCcsIFthdG9tc0VsZW1lbnRdKTtcbiAgfVxuXG4gIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvJHtlbH0vc2NyZWVuc2hvdGAsICdHRVQnKTtcbiAgaWYgKCFfLmlzU3RyaW5nKGRhdGEpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFVuYWJsZSB0byB0YWtlIGEgc2NyZWVuc2hvdCBvZiB0aGUgZWxlbWVudCAke2VsfS4gV0RBIHJldHVybmVkICcke0pTT04uc3RyaW5naWZ5KGRhdGEpfSdgKTtcbiAgfVxuICByZXR1cm4gZGF0YTtcbn07XG5cbmNvbW1hbmRzLmdldFZpZXdwb3J0U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFZpZXdwb3J0U2NyZWVuc2hvdCAoKSB7XG4gIGxldCBzdGF0dXNCYXJIZWlnaHQgPSBhd2FpdCB0aGlzLmdldFN0YXR1c0JhckhlaWdodCgpO1xuICBjb25zdCBzY3JlZW5zaG90ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5zaG90KCk7XG5cbiAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBhIHN0YXR1cyBiYXIsIHRoZXJlJ3Mgbm90aGluZyB0byBjcm9wLCBzbyB3ZSBjYW4gYXZvaWRcbiAgLy8gZXh0cmEgY2FsbHMgYW5kIHJldHVybiBzdHJhaWdodGF3YXlcbiAgaWYgKHN0YXR1c0JhckhlaWdodCA9PT0gMCkge1xuICAgIHJldHVybiBzY3JlZW5zaG90O1xuICB9XG5cbiAgY29uc3Qgc2NhbGUgPSBhd2FpdCB0aGlzLmdldERldmljZVBpeGVsUmF0aW8oKTtcbiAgLy8gc3RhdHVzIGJhciBoZWlnaHQgY29tZXMgaW4gdW5zY2FsZWQsIHNvIHNjYWxlIGl0XG4gIHN0YXR1c0JhckhlaWdodCA9IE1hdGgucm91bmQoc3RhdHVzQmFySGVpZ2h0ICogc2NhbGUpO1xuICBjb25zdCB3aW5kb3dTaXplID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG4gIGxldCByZWN0ID0ge1xuICAgIGxlZnQ6IDAsXG4gICAgdG9wOiBzdGF0dXNCYXJIZWlnaHQsXG4gICAgd2lkdGg6IHdpbmRvd1NpemUud2lkdGggKiBzY2FsZSxcbiAgICBoZWlnaHQ6ICgod2luZG93U2l6ZS5oZWlnaHQgKiBzY2FsZSkgLSBzdGF0dXNCYXJIZWlnaHQpXG4gIH07XG4gIGxldCBuZXdTY3JlZW5zaG90ID0gYXdhaXQgaW1hZ2VVdGlsLmNyb3BCYXNlNjRJbWFnZShzY3JlZW5zaG90LCByZWN0KTtcbiAgcmV0dXJuIG5ld1NjcmVlbnNob3Q7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3NjcmVlbnNob3RzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
