"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "BOOTSTRAP_PATH", {
  enumerable: true,
  get: function () {
    return _appiumWebdriveragent.BOOTSTRAP_PATH;
  }
});
Object.defineProperty(exports, "WDA_BUNDLE_ID", {
  enumerable: true,
  get: function () {
    return _appiumWebdriveragent.WDA_BUNDLE_ID;
  }
});
exports.WDA_BASE_URL = exports.WebDriverAgent = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _url2 = _interopRequireDefault(require("url"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _noSessionProxy = require("./no-session-proxy");

var _utils = require("./utils");

var _utils2 = require("../utils");

var _xcodebuild = _interopRequireDefault(require("./xcodebuild"));

var _iproxy = _interopRequireDefault(require("./iproxy"));

var _teen_process = require("teen_process");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _appiumWebdriveragent = require("appium-webdriveragent");

const WDA_LAUNCH_TIMEOUT = 60 * 1000;
const WDA_AGENT_PORT = 8100;
const WDA_BASE_URL = 'http://localhost';
exports.WDA_BASE_URL = WDA_BASE_URL;
const SHARED_RESOURCES_GUARD = new _asyncLock.default();

class WebDriverAgent {
  constructor(xcodeVersion, args = {}) {
    this.xcodeVersion = xcodeVersion;
    this.args = _lodash.default.clone(args);
    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.platformName = args.platformName;
    this.iosSdkVersion = args.iosSdkVersion;
    this.host = args.host;
    this.realDevice = !!args.realDevice;
    this.setWDAPaths(args.bootstrapPath, args.agentPath);
    this.wdaLocalPort = args.wdaLocalPort;
    this.wdaBaseUrl = args.wdaBaseUrl || WDA_BASE_URL;
    this.prebuildWDA = args.prebuildWDA;
    this.webDriverAgentUrl = args.webDriverAgentUrl;
    this.started = false;
    this.wdaConnectionTimeout = args.wdaConnectionTimeout;
    this.useCarthageSsl = _lodash.default.isBoolean(args.useCarthageSsl) && args.useCarthageSsl;
    this.useXctestrunFile = args.useXctestrunFile;
    this.xcodebuild = new _xcodebuild.default(this.xcodeVersion, this.device, {
      platformVersion: this.platformVersion,
      platformName: this.platformName,
      iosSdkVersion: this.iosSdkVersion,
      agentPath: this.agentPath,
      bootstrapPath: this.bootstrapPath,
      realDevice: this.realDevice,
      showXcodeLog: args.showXcodeLog,
      xcodeConfigFile: args.xcodeConfigFile,
      xcodeOrgId: args.xcodeOrgId,
      xcodeSigningId: args.xcodeSigningId,
      keychainPath: args.keychainPath,
      keychainPassword: args.keychainPassword,
      useSimpleBuildTest: args.useSimpleBuildTest,
      usePrebuiltWDA: args.usePrebuiltWDA,
      updatedWDABundleId: args.updatedWDABundleId,
      launchTimeout: args.wdaLaunchTimeout || WDA_LAUNCH_TIMEOUT,
      wdaRemotePort: this.realDevice ? WDA_AGENT_PORT : this.wdaLocalPort || WDA_AGENT_PORT,
      useXctestrunFile: this.useXctestrunFile,
      derivedDataPath: args.derivedDataPath,
      mjpegServerPort: args.mjpegServerPort
    });
  }

  setWDAPaths(bootstrapPath, agentPath) {
    this.bootstrapPath = bootstrapPath || _appiumWebdriveragent.BOOTSTRAP_PATH;

    _logger.default.info(`Using WDA path: '${this.bootstrapPath}'`);

    this.agentPath = agentPath || _path.default.resolve(this.bootstrapPath, 'WebDriverAgent.xcodeproj');

    _logger.default.info(`Using WDA agent: '${this.agentPath}'`);
  }

  async cleanupObsoleteProcesses() {
    const obsoletePids = await (0, _utils2.getPIDsListeningOnPort)(this.url.port, cmdLine => (cmdLine.includes('/WebDriverAgentRunner') || cmdLine.includes('/iproxy')) && !cmdLine.toLowerCase().includes(this.device.udid.toLowerCase()));

    if (this.realDevice) {
      const allIproxyDevicePids = await (0, _utils2.getPIDsUsingPattern)(`iproxy[[:space:]]+[0-9]+[[:space:]]+${WDA_AGENT_PORT}[[:space:]]+${this.device.udid}`, {
        multi: true
      });

      if (allIproxyDevicePids) {
        const iproxyDevicePidsOnLocalPort = await (0, _utils2.getPIDsUsingPattern)(`iproxy[[:space:]]+${this.url.port}[[:space:]]+${WDA_AGENT_PORT}[[:space:]]+${this.device.udid}`, {
          multi: true
        });

        if (!_lodash.default.isEqual(allIproxyDevicePids, iproxyDevicePidsOnLocalPort)) {
          obsoletePids.push(..._lodash.default.difference(allIproxyDevicePids, iproxyDevicePidsOnLocalPort || []));
        }
      }
    }

    if (_lodash.default.isEmpty(obsoletePids)) {
      _logger.default.debug(`No obsolete cached processes from previous WDA sessions ` + `listening on port ${this.url.port} have been found`);

      return;
    }

    _logger.default.info(`Detected ${obsoletePids.length} obsolete cached process${obsoletePids.length === 1 ? '' : 'es'} ` + `from previous WDA sessions. Cleaning them up`);

    try {
      await (0, _teen_process.exec)('kill', obsoletePids);
    } catch (e) {
      _logger.default.warn(`Failed to kill obsolete cached process${obsoletePids.length === 1 ? '' : 'es'} '${obsoletePids}'. ` + `Original error: ${e.message}`);
    }
  }

  async isRunning() {
    return !!(await this.getStatus());
  }

  async getStatus() {
    const noSessionProxy = new _noSessionProxy.NoSessionProxy({
      server: this.url.hostname,
      port: this.url.port,
      base: '',
      timeout: 3000
    });

    try {
      return await noSessionProxy.command('/status', 'GET');
    } catch (err) {
      _logger.default.debug(`WDA is not listening at '${this.url.href}'`);

      return null;
    }
  }

  async uninstall() {
    _logger.default.debug(`Removing WDA application from device`);

    try {
      await this.device.removeApp(_appiumWebdriveragent.WDA_BUNDLE_ID);
    } catch (e) {
      _logger.default.warn(`WebDriverAgent uninstall failed. Perhaps, it is already uninstalled? Original error: ${JSON.stringify(e)}`);
    }
  }

  async launch(sessionId) {
    if (this.webDriverAgentUrl) {
      _logger.default.info(`Using provided WebdriverAgent at '${this.webDriverAgentUrl}'`);

      this.url = this.webDriverAgentUrl;
      this.setupProxies(sessionId);
      return await this.getStatus();
    }

    _logger.default.info('Launching WebDriverAgent on the device');

    this.setupProxies(sessionId);

    if (!this.useXctestrunFile && !(await _appiumSupport.fs.exists(this.agentPath))) {
      throw new Error(`Trying to use WebDriverAgent project at '${this.agentPath}' but the ` + 'file does not exist');
    }

    if (!this.useXctestrunFile) {
      const synchronizationKey = _path.default.normalize(this.bootstrapPath);

      await SHARED_RESOURCES_GUARD.acquire(synchronizationKey, async () => {
        const didPerformUpgrade = await (0, _appiumWebdriveragent.checkForDependencies)(this.bootstrapPath, this.useCarthageSsl);

        if (didPerformUpgrade) {
          await this.xcodebuild.cleanProject();
        }
      });
    }

    await (0, _utils2.resetXCTestProcesses)(this.device.udid, !this.realDevice, {
      wdaLocalPort: this.url.port
    });

    if (this.realDevice) {
      if ((0, _utils2.isLocalHost)(this.wdaBaseUrl)) {
        this.iproxy = new _iproxy.default(this.device.udid, this.url.port, WDA_AGENT_PORT);
        await this.iproxy.start();
      } else {
        _logger.default.info(`Skip starting iproxy since Appium will communicate with WDA via '${this.wdaBaseUrl}'`);
      }
    }

    await this.xcodebuild.init(this.noSessionProxy);

    if (this.prebuildWDA) {
      await this.xcodebuild.prebuild();
    }

    return await this.xcodebuild.start();
  }

  async isSourceFresh() {
    for (const subPath of [_utils.CARTHAGE_ROOT, 'Resources', `Resources${_path.default.sep}WebDriverAgent.bundle`]) {
      if (!(await _appiumSupport.fs.exists(_path.default.resolve(this.bootstrapPath, subPath)))) {
        return true;
      }
    }

    return false;
  }

  setupProxies(sessionId) {
    const proxyOpts = {
      server: this.url.hostname,
      port: this.url.port,
      base: '',
      timeout: this.wdaConnectionTimeout,
      keepAlive: true
    };
    this.jwproxy = new _appiumBaseDriver.JWProxy(proxyOpts);
    this.jwproxy.sessionId = sessionId;
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.noSessionProxy = new _noSessionProxy.NoSessionProxy(proxyOpts);
    this.noSessionProxyReqRes = this.noSessionProxy.proxyReqRes.bind(this.noSessionProxy);
  }

  async quit() {
    _logger.default.info('Shutting down sub-processes');

    if (this.iproxy) {
      await this.iproxy.quit();
    }

    await this.xcodebuild.quit();
    await this.xcodebuild.reset();

    if (this.jwproxy) {
      this.jwproxy.sessionId = null;
    }

    this.started = false;

    if (!this.args.webDriverAgentUrl) {
      this.webDriverAgentUrl = null;
    }
  }

  get url() {
    if (!this._url) {
      const port = this.wdaLocalPort || WDA_AGENT_PORT;

      const {
        protocol,
        hostname
      } = _url2.default.parse(this.wdaBaseUrl || WDA_BASE_URL);

      this._url = _url2.default.parse(`${protocol}//${hostname}:${port}`);
    }

    return this._url;
  }

  set url(_url) {
    this._url = _url2.default.parse(_url);
  }

  get fullyStarted() {
    return this.started;
  }

  set fullyStarted(started = false) {
    this.started = started;

    if (this.iproxy) {
      this.iproxy.expectIProxyErrors = !started;
    }
  }

  async retrieveDerivedDataPath() {
    return await this.xcodebuild.retrieveDerivedDataPath();
  }

  async setupCaching(updatedWDABundleId) {
    const status = await this.getStatus();

    if (!status || !status.build) {
      _logger.default.debug('WDA is currently not running. There is nothing to cache');

      return;
    }

    const {
      productBundleIdentifier,
      upgradedAt
    } = status.build;

    if (_appiumSupport.util.hasValue(productBundleIdentifier) && _appiumSupport.util.hasValue(updatedWDABundleId) && updatedWDABundleId !== productBundleIdentifier) {
      _logger.default.info(`Will uninstall running WDA since it has different bundle id. The actual value is '${productBundleIdentifier}'.`);

      return await this.uninstall();
    }

    if (_appiumSupport.util.hasValue(productBundleIdentifier) && !_appiumSupport.util.hasValue(updatedWDABundleId) && _appiumWebdriveragent.WDA_RUNNER_BUNDLE_ID !== productBundleIdentifier) {
      _logger.default.info(`Will uninstall running WDA since its bundle id is not equal to the default value ${_appiumWebdriveragent.WDA_RUNNER_BUNDLE_ID}`);

      return await this.uninstall();
    }

    const actualUpgradeTimestamp = await (0, _utils.getWDAUpgradeTimestamp)(this.bootstrapPath);

    _logger.default.debug(`Upgrade timestamp of the currently bundled WDA: ${actualUpgradeTimestamp}`);

    _logger.default.debug(`Upgrade timestamp of the WDA on the device: ${upgradedAt}`);

    if (actualUpgradeTimestamp && upgradedAt && _lodash.default.toLower(`${actualUpgradeTimestamp}`) !== _lodash.default.toLower(`${upgradedAt}`)) {
      _logger.default.info('Will uninstall running WDA since it has different version in comparison to the one ' + `which is bundled with appium-xcuitest-driver module (${actualUpgradeTimestamp} != ${upgradedAt})`);

      return await this.uninstall();
    }

    const message = _appiumSupport.util.hasValue(productBundleIdentifier) ? `Will reuse previously cached WDA instance at '${this.url.href}' with '${productBundleIdentifier}'` : `Will reuse previously cached WDA instance at '${this.url.href}'`;

    _logger.default.info(`${message}. Set the wdaLocalPort capability to a value different from ${this.url.port} if this is an undesired behavior.`);

    this.webDriverAgentUrl = this.url.href;
  }

  async quitAndUninstall() {
    await this.quit();
    await this.uninstall();
  }

}

exports.WebDriverAgent = WebDriverAgent;
var _default = WebDriverAgent;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvd2ViZHJpdmVyYWdlbnQuanMiXSwibmFtZXMiOlsiV0RBX0xBVU5DSF9USU1FT1VUIiwiV0RBX0FHRU5UX1BPUlQiLCJXREFfQkFTRV9VUkwiLCJTSEFSRURfUkVTT1VSQ0VTX0dVQVJEIiwiQXN5bmNMb2NrIiwiV2ViRHJpdmVyQWdlbnQiLCJjb25zdHJ1Y3RvciIsInhjb2RlVmVyc2lvbiIsImFyZ3MiLCJfIiwiY2xvbmUiLCJkZXZpY2UiLCJwbGF0Zm9ybVZlcnNpb24iLCJwbGF0Zm9ybU5hbWUiLCJpb3NTZGtWZXJzaW9uIiwiaG9zdCIsInJlYWxEZXZpY2UiLCJzZXRXREFQYXRocyIsImJvb3RzdHJhcFBhdGgiLCJhZ2VudFBhdGgiLCJ3ZGFMb2NhbFBvcnQiLCJ3ZGFCYXNlVXJsIiwicHJlYnVpbGRXREEiLCJ3ZWJEcml2ZXJBZ2VudFVybCIsInN0YXJ0ZWQiLCJ3ZGFDb25uZWN0aW9uVGltZW91dCIsInVzZUNhcnRoYWdlU3NsIiwiaXNCb29sZWFuIiwidXNlWGN0ZXN0cnVuRmlsZSIsInhjb2RlYnVpbGQiLCJYY29kZUJ1aWxkIiwic2hvd1hjb2RlTG9nIiwieGNvZGVDb25maWdGaWxlIiwieGNvZGVPcmdJZCIsInhjb2RlU2lnbmluZ0lkIiwia2V5Y2hhaW5QYXRoIiwia2V5Y2hhaW5QYXNzd29yZCIsInVzZVNpbXBsZUJ1aWxkVGVzdCIsInVzZVByZWJ1aWx0V0RBIiwidXBkYXRlZFdEQUJ1bmRsZUlkIiwibGF1bmNoVGltZW91dCIsIndkYUxhdW5jaFRpbWVvdXQiLCJ3ZGFSZW1vdGVQb3J0IiwiZGVyaXZlZERhdGFQYXRoIiwibWpwZWdTZXJ2ZXJQb3J0IiwiQk9PVFNUUkFQX1BBVEgiLCJsb2ciLCJpbmZvIiwicGF0aCIsInJlc29sdmUiLCJjbGVhbnVwT2Jzb2xldGVQcm9jZXNzZXMiLCJvYnNvbGV0ZVBpZHMiLCJ1cmwiLCJwb3J0IiwiY21kTGluZSIsImluY2x1ZGVzIiwidG9Mb3dlckNhc2UiLCJ1ZGlkIiwiYWxsSXByb3h5RGV2aWNlUGlkcyIsIm11bHRpIiwiaXByb3h5RGV2aWNlUGlkc09uTG9jYWxQb3J0IiwiaXNFcXVhbCIsInB1c2giLCJkaWZmZXJlbmNlIiwiaXNFbXB0eSIsImRlYnVnIiwibGVuZ3RoIiwiZSIsIndhcm4iLCJtZXNzYWdlIiwiaXNSdW5uaW5nIiwiZ2V0U3RhdHVzIiwibm9TZXNzaW9uUHJveHkiLCJOb1Nlc3Npb25Qcm94eSIsInNlcnZlciIsImhvc3RuYW1lIiwiYmFzZSIsInRpbWVvdXQiLCJjb21tYW5kIiwiZXJyIiwiaHJlZiIsInVuaW5zdGFsbCIsInJlbW92ZUFwcCIsIldEQV9CVU5ETEVfSUQiLCJKU09OIiwic3RyaW5naWZ5IiwibGF1bmNoIiwic2Vzc2lvbklkIiwic2V0dXBQcm94aWVzIiwiZnMiLCJleGlzdHMiLCJFcnJvciIsInN5bmNocm9uaXphdGlvbktleSIsIm5vcm1hbGl6ZSIsImFjcXVpcmUiLCJkaWRQZXJmb3JtVXBncmFkZSIsImNsZWFuUHJvamVjdCIsImlwcm94eSIsImlQcm94eSIsInN0YXJ0IiwiaW5pdCIsInByZWJ1aWxkIiwiaXNTb3VyY2VGcmVzaCIsInN1YlBhdGgiLCJDQVJUSEFHRV9ST09UIiwic2VwIiwicHJveHlPcHRzIiwia2VlcEFsaXZlIiwiandwcm94eSIsIkpXUHJveHkiLCJwcm94eVJlcVJlcyIsImJpbmQiLCJub1Nlc3Npb25Qcm94eVJlcVJlcyIsInF1aXQiLCJyZXNldCIsIl91cmwiLCJwcm90b2NvbCIsInBhcnNlIiwiZnVsbHlTdGFydGVkIiwiZXhwZWN0SVByb3h5RXJyb3JzIiwicmV0cmlldmVEZXJpdmVkRGF0YVBhdGgiLCJzZXR1cENhY2hpbmciLCJzdGF0dXMiLCJidWlsZCIsInByb2R1Y3RCdW5kbGVJZGVudGlmaWVyIiwidXBncmFkZWRBdCIsInV0aWwiLCJoYXNWYWx1ZSIsIldEQV9SVU5ORVJfQlVORExFX0lEIiwiYWN0dWFsVXBncmFkZVRpbWVzdGFtcCIsInRvTG93ZXIiLCJxdWl0QW5kVW5pbnN0YWxsIl0sIm1hcHBp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Z0JBQU4sR0FBMEI7QUFDeEIsVUFBTSxLQUFLbEIsSUFBTCxFQUFOO0FBQ0EsVUFBTSxLQUFLaEMsU0FBTCxFQUFOO0FBQ0Q7O0FBMVdrQjs7O2VBNldONUUsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBOb1Nlc3Npb25Qcm94eSB9IGZyb20gJy4vbm8tc2Vzc2lvbi1wcm94eSc7XG5pbXBvcnQgeyBnZXRXREFVcGdyYWRlVGltZXN0YW1wLCBDQVJUSEFHRV9ST09UIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQge1xuICByZXNldFhDVGVzdFByb2Nlc3NlcywgZ2V0UElEc0xpc3RlbmluZ09uUG9ydCwgaXNMb2NhbEhvc3QsXG4gIGdldFBJRHNVc2luZ1BhdHRlcm4gfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgWGNvZGVCdWlsZCBmcm9tICcuL3hjb2RlYnVpbGQnO1xuaW1wb3J0IGlQcm94eSBmcm9tICcuL2lwcm94eSc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBBc3luY0xvY2sgZnJvbSAnYXN5bmMtbG9jayc7XG5pbXBvcnQgeyBCT09UU1RSQVBfUEFUSCwgV0RBX0JVTkRMRV9JRCwgV0RBX1JVTk5FUl9CVU5ETEVfSUQsIGNoZWNrRm9yRGVwZW5kZW5jaWVzIH0gZnJvbSAnYXBwaXVtLXdlYmRyaXZlcmFnZW50JztcblxuXG5jb25zdCBXREFfTEFVTkNIX1RJTUVPVVQgPSA2MCAqIDEwMDA7XG5jb25zdCBXREFfQUdFTlRfUE9SVCA9IDgxMDA7XG5jb25zdCBXREFfQkFTRV9VUkwgPSAnaHR0cDovL2xvY2FsaG9zdCc7XG5cbmNvbnN0IFNIQVJFRF9SRVNPVVJDRVNfR1VBUkQgPSBuZXcgQXN5bmNMb2NrKCk7XG5cblxuY2xhc3MgV2ViRHJpdmVyQWdlbnQge1xuICBjb25zdHJ1Y3RvciAoeGNvZGVWZXJzaW9uLCBhcmdzID0ge30pIHtcbiAgICB0aGlzLnhjb2RlVmVyc2lvbiA9IHhjb2RlVmVyc2lvbjtcblxuICAgIHRoaXMuYXJncyA9IF8uY2xvbmUoYXJncyk7XG5cbiAgICB0aGlzLmRldmljZSA9IGFyZ3MuZGV2aWNlO1xuICAgIHRoaXMucGxhdGZvcm1WZXJzaW9uID0gYXJncy5wbGF0Zm9ybVZlcnNpb247XG4gICAgdGhpcy5wbGF0Zm9ybU5hbWUgPSBhcmdzLnBsYXRmb3JtTmFtZTtcbiAgICB0aGlzLmlvc1Nka1ZlcnNpb24gPSBhcmdzLmlvc1Nka1ZlcnNpb247XG4gICAgdGhpcy5ob3N0ID0gYXJncy5ob3N0O1xuICAgIHRoaXMucmVhbERldmljZSA9ICEhYXJncy5yZWFsRGV2aWNlO1xuXG4gICAgdGhpcy5zZXRXREFQYXRocyhhcmdzLmJvb3RzdHJhcFBhdGgsIGFyZ3MuYWdlbnRQYXRoKTtcblxuICAgIHRoaXMud2RhTG9jYWxQb3J0ID0gYXJncy53ZGFMb2NhbFBvcnQ7XG4gICAgdGhpcy53ZGFCYXNlVXJsID0gYXJncy53ZGFCYXNlVXJsIHx8IFdEQV9CQVNFX1VSTDtcblxuICAgIHRoaXMucHJlYnVpbGRXREEgPSBhcmdzLnByZWJ1aWxkV0RBO1xuXG4gICAgdGhpcy53ZWJEcml2ZXJBZ2VudFVybCA9IGFyZ3Mud2ViRHJpdmVyQWdlbnRVcmw7XG5cbiAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcblxuICAgIHRoaXMud2RhQ29ubmVjdGlvblRpbWVvdXQgPSBhcmdzLndkYUNvbm5lY3Rpb25UaW1lb3V0O1xuXG4gICAgdGhpcy51c2VDYXJ0aGFnZVNzbCA9IF8uaXNCb29sZWFuKGFyZ3MudXNlQ2FydGhhZ2VTc2wpICYmIGFyZ3MudXNlQ2FydGhhZ2VTc2w7XG5cbiAgICB0aGlzLnVzZVhjdGVzdHJ1bkZpbGUgPSBhcmdzLnVzZVhjdGVzdHJ1bkZpbGU7XG5cbiAgICB0aGlzLnhjb2RlYnVpbGQgPSBuZXcgWGNvZGVCdWlsZCh0aGlzLnhjb2RlVmVyc2lvbiwgdGhpcy5kZXZpY2UsIHtcbiAgICAgIHBsYXRmb3JtVmVyc2lvbjogdGhpcy5wbGF0Zm9ybVZlcnNpb24sXG4gICAgICBwbGF0Zm9ybU5hbWU6IHRoaXMucGxhdGZvcm1OYW1lLFxuICAgICAgaW9zU2RrVmVyc2lvbjogdGhpcy5pb3NTZGtWZXJzaW9uLFxuICAgICAgYWdlbnRQYXRoOiB0aGlzLmFnZW50UGF0aCxcbiAgICAgIGJvb3RzdHJhcFBhdGg6IHRoaXMuYm9vdHN0cmFwUGF0aCxcbiAgICAgIHJlYWxEZXZpY2U6IHRoaXMucmVhbERldmljZSxcbiAgICAgIHNob3dYY29kZUxvZzogYXJncy5zaG93WGNvZGVMb2csXG4gICAgICB4Y29kZUNvbmZpZ0ZpbGU6IGFyZ3MueGNvZGVDb25maWdGaWxlLFxuICAgICAgeGNvZGVPcmdJZDogYXJncy54Y29kZU9yZ0lkLFxuICAgICAgeGNvZGVTaWduaW5nSWQ6IGFyZ3MueGNvZGVTaWduaW5nSWQsXG4gICAgICBrZXljaGFpblBhdGg6IGFyZ3Mua2V5Y2hhaW5QYXRoLFxuICAgICAga2V5Y2hhaW5QYXNzd29yZDogYXJncy5rZXljaGFpblBhc3N3b3JkLFxuICAgICAgdXNlU2ltcGxlQnVpbGRUZXN0OiBhcmdzLnVzZVNpbXBsZUJ1aWxkVGVzdCxcbiAgICAgIHVzZVByZWJ1aWx0V0RBOiBhcmdzLnVzZVByZWJ1aWx0V0RBLFxuICAgICAgdXBkYXRlZFdEQUJ1bmRsZUlkOiBhcmdzLnVwZGF0ZWRXREFCdW5kbGVJZCxcbiAgICAgIGxhdW5jaFRpbWVvdXQ6IGFyZ3Mud2RhTGF1bmNoVGltZW91dCB8fCBXREFfTEFVTkNIX1RJTUVPVVQsXG4gICAgICB3ZGFSZW1vdGVQb3J0OiB0aGlzLnJlYWxEZXZpY2UgPyBXREFfQUdFTlRfUE9SVCA6ICh0aGlzLndkYUxvY2FsUG9ydCB8fCBXREFfQUdFTlRfUE9SVCksXG4gICAgICB1c2VYY3Rlc3RydW5GaWxlOiB0aGlzLnVzZVhjdGVzdHJ1bkZpbGUsXG4gICAgICBkZXJpdmVkRGF0YVBhdGg6IGFyZ3MuZGVyaXZlZERhdGFQYXRoLFxuICAgICAgbWpwZWdTZXJ2ZXJQb3J0OiBhcmdzLm1qcGVnU2VydmVyUG9ydCxcbiAgICB9KTtcbiAgfVxuXG4gIHNldFdEQVBhdGhzIChib290c3RyYXBQYXRoLCBhZ2VudFBhdGgpIHtcbiAgICAvLyBhbGxvdyB0aGUgdXNlciB0byBzcGVjaWZ5IGEgcGxhY2UgZm9yIFdEQS4gVGhpcyBpcyB1bmRvY3VtZW50ZWQgYW5kXG4gICAgLy8gb25seSBoZXJlIGZvciB0aGUgcHVycG9zZXMgb2YgdGVzdGluZyBkZXZlbG9wbWVudCBvZiBXREFcbiAgICB0aGlzLmJvb3RzdHJhcFBhdGggPSBib290c3RyYXBQYXRoIHx8IEJPT1RTVFJBUF9QQVRIO1xuICAgIGxvZy5pbmZvKGBVc2luZyBXREEgcGF0aDogJyR7dGhpcy5ib290c3RyYXBQYXRofSdgKTtcblxuICAgIC8vIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IHdlIG5lZWQgdG8gYmUgYWJsZSB0byBzcGVjaWZ5IGFnZW50UGF0aCB0b29cbiAgICB0aGlzLmFnZW50UGF0aCA9IGFnZW50UGF0aCB8fCBwYXRoLnJlc29sdmUodGhpcy5ib290c3RyYXBQYXRoLCAnV2ViRHJpdmVyQWdlbnQueGNvZGVwcm9qJyk7XG4gICAgbG9nLmluZm8oYFVzaW5nIFdEQSBhZ2VudDogJyR7dGhpcy5hZ2VudFBhdGh9J2ApO1xuICB9XG5cbiAgYXN5bmMgY2xlYW51cE9ic29sZXRlUHJvY2Vzc2VzICgpIHtcbiAgICBjb25zdCBvYnNvbGV0ZVBpZHMgPSBhd2FpdCBnZXRQSURzTGlzdGVuaW5nT25Qb3J0KHRoaXMudXJsLnBvcnQsXG4gICAgICAoY21kTGluZSkgPT4gKGNtZExpbmUuaW5jbHVkZXMoJy9XZWJEcml2ZXJBZ2VudFJ1bm5lcicpIHx8IGNtZExpbmUuaW5jbHVkZXMoJy9pcHJveHknKSkgJiZcbiAgICAgICAgIWNtZExpbmUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0aGlzLmRldmljZS51ZGlkLnRvTG93ZXJDYXNlKCkpKTtcblxuICAgIGlmICh0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xMjY0OVxuICAgICAgY29uc3QgYWxsSXByb3h5RGV2aWNlUGlkcyA9IGF3YWl0IGdldFBJRHNVc2luZ1BhdHRlcm4oXG4gICAgICAgIGBpcHJveHlbWzpzcGFjZTpdXStbMC05XStbWzpzcGFjZTpdXSske1dEQV9BR0VOVF9QT1JUfVtbOnNwYWNlOl1dKyR7dGhpcy5kZXZpY2UudWRpZH1gLCB7XG4gICAgICAgICAgbXVsdGk6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgaWYgKGFsbElwcm94eURldmljZVBpZHMpIHtcbiAgICAgICAgY29uc3QgaXByb3h5RGV2aWNlUGlkc09uTG9jYWxQb3J0ID0gYXdhaXQgZ2V0UElEc1VzaW5nUGF0dGVybihcbiAgICAgICAgICBgaXByb3h5W1s6c3BhY2U6XV0rJHt0aGlzLnVybC5wb3J0fVtbOnNwYWNlOl1dKyR7V0RBX0FHRU5UX1BPUlR9W1s6c3BhY2U6XV0rJHt0aGlzLmRldmljZS51ZGlkfWAsIHtcbiAgICAgICAgICAgIG11bHRpOiB0cnVlLFxuICAgICAgICAgIH0pO1xuICAgICAgICBpZiAoIV8uaXNFcXVhbChhbGxJcHJveHlEZXZpY2VQaWRzLCBpcHJveHlEZXZpY2VQaWRzT25Mb2NhbFBvcnQpKSB7XG4gICAgICAgICAgb2Jzb2xldGVQaWRzLnB1c2goLi4uXy5kaWZmZXJlbmNlKGFsbElwcm94eURldmljZVBpZHMsIGlwcm94eURldmljZVBpZHNPbkxvY2FsUG9ydCB8fCBbXSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKF8uaXNFbXB0eShvYnNvbGV0ZVBpZHMpKSB7XG4gICAgICBsb2cuZGVidWcoYE5vIG9ic29sZXRlIGNhY2hlZCBwcm9jZXNzZXMgZnJvbSBwcmV2aW91cyBXREEgc2Vzc2lvbnMgYCArXG4gICAgICAgIGBsaXN0ZW5pbmcgb24gcG9ydCAke3RoaXMudXJsLnBvcnR9IGhhdmUgYmVlbiBmb3VuZGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZy5pbmZvKGBEZXRlY3RlZCAke29ic29sZXRlUGlkcy5sZW5ndGh9IG9ic29sZXRlIGNhY2hlZCBwcm9jZXNzJHtvYnNvbGV0ZVBpZHMubGVuZ3RoID09PSAxID8gJycgOiAnZXMnfSBgICtcbiAgICAgIGBmcm9tIHByZXZpb3VzIFdEQSBzZXNzaW9ucy4gQ2xlYW5pbmcgdGhlbSB1cGApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKCdraWxsJywgb2Jzb2xldGVQaWRzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cud2FybihgRmFpbGVkIHRvIGtpbGwgb2Jzb2xldGUgY2FjaGVkIHByb2Nlc3Mke29ic29sZXRlUGlkcy5sZW5ndGggPT09IDEgPyAnJyA6ICdlcyd9ICcke29ic29sZXRlUGlkc30nLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGJvb2xlYW4gaWYgV0RBIGlzIHJ1bm5pbmcgb3Igbm90XG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgV0RBIGlzIHJ1bm5pbmdcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBpbnZhbGlkIHJlc3BvbnNlIGNvZGUgb3IgYm9keVxuICAgKi9cbiAgYXN5bmMgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gISEoYXdhaXQgdGhpcy5nZXRTdGF0dXMoKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGN1cnJlbnQgcnVubmluZyBXREEncyBzdGF0dXMgbGlrZSBiZWxvd1xuICAgKiB7XG4gICAqICAgXCJzdGF0ZVwiOiBcInN1Y2Nlc3NcIixcbiAgICogICBcIm9zXCI6IHtcbiAgICogICAgIFwibmFtZVwiOiBcImlPU1wiLFxuICAgKiAgICAgXCJ2ZXJzaW9uXCI6IFwiMTEuNFwiLFxuICAgKiAgICAgXCJzZGtWZXJzaW9uXCI6IFwiMTEuM1wiXG4gICAqICAgfSxcbiAgICogICBcImlvc1wiOiB7XG4gICAqICAgICBcInNpbXVsYXRvclZlcnNpb25cIjogXCIxMS40XCIsXG4gICAqICAgICBcImlwXCI6IFwiMTcyLjI1NC45OS4zNFwiXG4gICAqICAgfSxcbiAgICogICBcImJ1aWxkXCI6IHtcbiAgICogICAgIFwidGltZVwiOiBcIkp1biAyNCAyMDE4IDE3OjA4OjIxXCIsXG4gICAqICAgICBcInByb2R1Y3RCdW5kbGVJZGVudGlmaWVyXCI6IFwiY29tLmZhY2Vib29rLldlYkRyaXZlckFnZW50UnVubmVyXCJcbiAgICogICB9XG4gICAqIH1cbiAgICpcbiAgICogQHJldHVybiB7P29iamVjdH0gU3RhdGUgT2JqZWN0XG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgaW52YWxpZCByZXNwb25zZSBjb2RlIG9yIGJvZHlcbiAgICovXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7XG4gICAgY29uc3Qgbm9TZXNzaW9uUHJveHkgPSBuZXcgTm9TZXNzaW9uUHJveHkoe1xuICAgICAgc2VydmVyOiB0aGlzLnVybC5ob3N0bmFtZSxcbiAgICAgIHBvcnQ6IHRoaXMudXJsLnBvcnQsXG4gICAgICBiYXNlOiAnJyxcbiAgICAgIHRpbWVvdXQ6IDMwMDAsXG4gICAgfSk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBub1Nlc3Npb25Qcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGBXREEgaXMgbm90IGxpc3RlbmluZyBhdCAnJHt0aGlzLnVybC5ocmVmfSdgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVuaW5zdGFsbCAoKSB7XG4gICAgbG9nLmRlYnVnKGBSZW1vdmluZyBXREEgYXBwbGljYXRpb24gZnJvbSBkZXZpY2VgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5kZXZpY2UucmVtb3ZlQXBwKFdEQV9CVU5ETEVfSUQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy53YXJuKGBXZWJEcml2ZXJBZ2VudCB1bmluc3RhbGwgZmFpbGVkLiBQZXJoYXBzLCBpdCBpcyBhbHJlYWR5IHVuaW5zdGFsbGVkPyBPcmlnaW5hbCBlcnJvcjogJHtKU09OLnN0cmluZ2lmeShlKX1gKTtcbiAgICB9XG4gIH1cblxuXG4gIC8qKlxuICAgKiBSZXR1cm4gY3VycmVudCBydW5uaW5nIFdEQSdzIHN0YXR1cyBsaWtlIGJlbG93IGFmdGVyIGxhdW5jaGluZyBXREFcbiAgICoge1xuICAgKiAgIFwic3RhdGVcIjogXCJzdWNjZXNzXCIsXG4gICAqICAgXCJvc1wiOiB7XG4gICAqICAgICBcIm5hbWVcIjogXCJpT1NcIixcbiAgICogICAgIFwidmVyc2lvblwiOiBcIjExLjRcIixcbiAgICogICAgIFwic2RrVmVyc2lvblwiOiBcIjExLjNcIlxuICAgKiAgIH0sXG4gICAqICAgXCJpb3NcIjoge1xuICAgKiAgICAgXCJzaW11bGF0b3JWZXJzaW9uXCI6IFwiMTEuNFwiLFxuICAgKiAgICAgXCJpcFwiOiBcIjE3Mi4yNTQuOTkuMzRcIlxuICAgKiAgIH0sXG4gICAqICAgXCJidWlsZFwiOiB7XG4gICAqICAgICBcInRpbWVcIjogXCJKdW4gMjQgMjAxOCAxNzowODoyMVwiLFxuICAgKiAgICAgXCJwcm9kdWN0QnVuZGxlSWRlbnRpZmllclwiOiBcImNvbS5mYWNlYm9vay5XZWJEcml2ZXJBZ2VudFJ1bm5lclwiXG4gICAqICAgfVxuICAgKiB9XG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZXNzaW9uSWQgTGF1bmNoIFdEQSBhbmQgZXN0YWJsaXNoIHRoZSBzZXNzaW9uIHdpdGggdGhpcyBzZXNzaW9uSWRcbiAgICogQHJldHVybiB7P29iamVjdH0gU3RhdGUgT2JqZWN0XG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgaW52YWxpZCByZXNwb25zZSBjb2RlIG9yIGJvZHlcbiAgICovXG4gIGFzeW5jIGxhdW5jaCAoc2Vzc2lvbklkKSB7XG4gICAgaWYgKHRoaXMud2ViRHJpdmVyQWdlbnRVcmwpIHtcbiAgICAgIGxvZy5pbmZvKGBVc2luZyBwcm92aWRlZCBXZWJkcml2ZXJBZ2VudCBhdCAnJHt0aGlzLndlYkRyaXZlckFnZW50VXJsfSdgKTtcbiAgICAgIHRoaXMudXJsID0gdGhpcy53ZWJEcml2ZXJBZ2VudFVybDtcbiAgICAgIHRoaXMuc2V0dXBQcm94aWVzKHNlc3Npb25JZCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRTdGF0dXMoKTtcbiAgICB9XG5cbiAgICBsb2cuaW5mbygnTGF1bmNoaW5nIFdlYkRyaXZlckFnZW50IG9uIHRoZSBkZXZpY2UnKTtcblxuICAgIHRoaXMuc2V0dXBQcm94aWVzKHNlc3Npb25JZCk7XG5cbiAgICBpZiAoIXRoaXMudXNlWGN0ZXN0cnVuRmlsZSAmJiAhYXdhaXQgZnMuZXhpc3RzKHRoaXMuYWdlbnRQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcnlpbmcgdG8gdXNlIFdlYkRyaXZlckFnZW50IHByb2plY3QgYXQgJyR7dGhpcy5hZ2VudFBhdGh9JyBidXQgdGhlIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICdmaWxlIGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnVzZVhjdGVzdHJ1bkZpbGUpIHtcbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBXREEgZGVwZW5kZW5jaWVzIGhhdmUgYmVlbiBidWlsdFxuICAgICAgY29uc3Qgc3luY2hyb25pemF0aW9uS2V5ID0gcGF0aC5ub3JtYWxpemUodGhpcy5ib290c3RyYXBQYXRoKTtcbiAgICAgIGF3YWl0IFNIQVJFRF9SRVNPVVJDRVNfR1VBUkQuYWNxdWlyZShzeW5jaHJvbml6YXRpb25LZXksIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgZGlkUGVyZm9ybVVwZ3JhZGUgPSBhd2FpdCBjaGVja0ZvckRlcGVuZGVuY2llcyh0aGlzLmJvb3RzdHJhcFBhdGgsIHRoaXMudXNlQ2FydGhhZ2VTc2wpO1xuICAgICAgICBpZiAoZGlkUGVyZm9ybVVwZ3JhZGUpIHtcbiAgICAgICAgICAvLyBPbmx5IHBlcmZvcm0gdGhlIGNsZWFudXAgYWZ0ZXIgV0RBIHVwZ3JhZGVcbiAgICAgICAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQuY2xlYW5Qcm9qZWN0KCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBXZSBuZWVkIHRvIHByb3ZpZGUgV0RBIGxvY2FsIHBvcnQsIGJlY2F1c2UgaXQgbWlnaHQgYmUgb2NjdXBpZWQgd2l0aFxuICAgIC8vIGlwcm94eSBpbnN0YW5jZSBpbml0aWF0ZWQgYnkgc29tZSBwcmVjZWRpbmcgcnVuIHdpdGggYSByZWFsIGRldmljZVxuICAgIC8vIChpcHJveHkgaW5zdGFuY2VzIGFyZSBub3Qga2lsbGVkIG9uIHNlc3Npb24gdGVybWluYXRpb24gYnkgZGVmYXVsdClcbiAgICBhd2FpdCByZXNldFhDVGVzdFByb2Nlc3Nlcyh0aGlzLmRldmljZS51ZGlkLCAhdGhpcy5yZWFsRGV2aWNlLCB7d2RhTG9jYWxQb3J0OiB0aGlzLnVybC5wb3J0fSk7XG5cbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlKSB7XG4gICAgICBpZiAoaXNMb2NhbEhvc3QodGhpcy53ZGFCYXNlVXJsKSkge1xuICAgICAgICB0aGlzLmlwcm94eSA9IG5ldyBpUHJveHkodGhpcy5kZXZpY2UudWRpZCwgdGhpcy51cmwucG9ydCwgV0RBX0FHRU5UX1BPUlQpO1xuICAgICAgICBhd2FpdCB0aGlzLmlwcm94eS5zdGFydCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmluZm8oYFNraXAgc3RhcnRpbmcgaXByb3h5IHNpbmNlIEFwcGl1bSB3aWxsIGNvbW11bmljYXRlIHdpdGggV0RBIHZpYSAnJHt0aGlzLndkYUJhc2VVcmx9J2ApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5pbml0KHRoaXMubm9TZXNzaW9uUHJveHkpO1xuXG4gICAgLy8gU3RhcnQgdGhlIHhjb2RlYnVpbGQgcHJvY2Vzc1xuICAgIGlmICh0aGlzLnByZWJ1aWxkV0RBKSB7XG4gICAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucHJlYnVpbGQoKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMueGNvZGVidWlsZC5zdGFydCgpO1xuICB9XG5cbiAgYXN5bmMgaXNTb3VyY2VGcmVzaCAoKSB7XG4gICAgZm9yIChjb25zdCBzdWJQYXRoIG9mIFtcbiAgICAgIENBUlRIQUdFX1JPT1QsXG4gICAgICAnUmVzb3VyY2VzJyxcbiAgICAgIGBSZXNvdXJjZXMke3BhdGguc2VwfVdlYkRyaXZlckFnZW50LmJ1bmRsZWAsXG4gICAgXSkge1xuICAgICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aC5yZXNvbHZlKHRoaXMuYm9vdHN0cmFwUGF0aCwgc3ViUGF0aCkpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBzZXR1cFByb3hpZXMgKHNlc3Npb25JZCkge1xuICAgIGNvbnN0IHByb3h5T3B0cyA9IHtcbiAgICAgIHNlcnZlcjogdGhpcy51cmwuaG9zdG5hbWUsXG4gICAgICBwb3J0OiB0aGlzLnVybC5wb3J0LFxuICAgICAgYmFzZTogJycsXG4gICAgICB0aW1lb3V0OiB0aGlzLndkYUNvbm5lY3Rpb25UaW1lb3V0LFxuICAgICAga2VlcEFsaXZlOiB0cnVlLFxuICAgIH07XG5cbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eShwcm94eU9wdHMpO1xuICAgIHRoaXMuandwcm94eS5zZXNzaW9uSWQgPSBzZXNzaW9uSWQ7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG5cbiAgICB0aGlzLm5vU2Vzc2lvblByb3h5ID0gbmV3IE5vU2Vzc2lvblByb3h5KHByb3h5T3B0cyk7XG4gICAgdGhpcy5ub1Nlc3Npb25Qcm94eVJlcVJlcyA9IHRoaXMubm9TZXNzaW9uUHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLm5vU2Vzc2lvblByb3h5KTtcbiAgfVxuXG4gIGFzeW5jIHF1aXQgKCkge1xuICAgIGxvZy5pbmZvKCdTaHV0dGluZyBkb3duIHN1Yi1wcm9jZXNzZXMnKTtcblxuICAgIGlmICh0aGlzLmlwcm94eSkge1xuICAgICAgYXdhaXQgdGhpcy5pcHJveHkucXVpdCgpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5xdWl0KCk7XG4gICAgYXdhaXQgdGhpcy54Y29kZWJ1aWxkLnJlc2V0KCk7XG5cbiAgICBpZiAodGhpcy5qd3Byb3h5KSB7XG4gICAgICB0aGlzLmp3cHJveHkuc2Vzc2lvbklkID0gbnVsbDtcbiAgICB9XG5cbiAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcblxuICAgIGlmICghdGhpcy5hcmdzLndlYkRyaXZlckFnZW50VXJsKSB7XG4gICAgICAvLyBpZiB3ZSBwb3B1bGF0ZWQgdGhlIHVybCBvdXJzZWx2ZXMgKGR1cmluZyBgc2V0dXBDYWNoaW5nYCBjYWxsLCBmb3IgaW5zdGFuY2UpXG4gICAgICAvLyB0aGVuIGNsZWFuIHRoYXQgdXAuIElmIHRoZSB1cmwgd2FzIHN1cHBsaWVkLCB3ZSB3YW50IHRvIGtlZXAgaXRcbiAgICAgIHRoaXMud2ViRHJpdmVyQWdlbnRVcmwgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGdldCB1cmwgKCkge1xuICAgIGlmICghdGhpcy5fdXJsKSB7XG4gICAgICBjb25zdCBwb3J0ID0gdGhpcy53ZGFMb2NhbFBvcnQgfHwgV0RBX0FHRU5UX1BPUlQ7XG4gICAgICBjb25zdCB7cHJvdG9jb2wsIGhvc3RuYW1lfSA9IHVybC5wYXJzZSh0aGlzLndkYUJhc2VVcmwgfHwgV0RBX0JBU0VfVVJMKTtcbiAgICAgIHRoaXMuX3VybCA9IHVybC5wYXJzZShgJHtwcm90b2NvbH0vLyR7aG9zdG5hbWV9OiR7cG9ydH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3VybDtcbiAgfVxuXG4gIHNldCB1cmwgKF91cmwpIHtcbiAgICB0aGlzLl91cmwgPSB1cmwucGFyc2UoX3VybCk7XG4gIH1cblxuICBnZXQgZnVsbHlTdGFydGVkICgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGFydGVkO1xuICB9XG5cbiAgc2V0IGZ1bGx5U3RhcnRlZCAoc3RhcnRlZCA9IGZhbHNlKSB7XG4gICAgLy8gYmVmb3JlIFdEQSBpcyBzdGFydGVkIHdlIGV4cGVjdCBlcnJvcnMgZnJvbSBpcHJveHksIHNpbmNlIGl0IGlzIG5vdFxuICAgIC8vIGNvbW11bmljYXRpbmcgd2l0aCBhbnl0aGluZyB5ZXRcbiAgICB0aGlzLnN0YXJ0ZWQgPSBzdGFydGVkO1xuICAgIGlmICh0aGlzLmlwcm94eSkge1xuICAgICAgdGhpcy5pcHJveHkuZXhwZWN0SVByb3h5RXJyb3JzID0gIXN0YXJ0ZWQ7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmV0cmlldmVEZXJpdmVkRGF0YVBhdGggKCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXVzZSBydW5uaW5nIFdEQSBpZiBpdCBoYXMgdGhlIHNhbWUgYnVuZGxlIGlkIHdpdGggdXBkYXRlZFdEQUJ1bmRsZUlkLlxuICAgKiBPciByZXVzZSBpdCBpZiBpdCBoYXMgdGhlIGRlZmF1bHQgaWQgd2l0aG91dCB1cGRhdGVkV0RBQnVuZGxlSWQuXG4gICAqIFVuaW5zdGFsbCBpdCBpZiB0aGUgbWV0aG9kIGZhY2VzIGFuIGV4Y2VwdGlvbiBmb3IgdGhlIGFib3ZlIHNpdHVhdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVwZGF0ZWRXREFCdW5kbGVJZCBCdW5kbGVJZCB5b3UnZCBsaWtlIHRvIHVzZVxuICAgKi9cbiAgYXN5bmMgc2V0dXBDYWNoaW5nICh1cGRhdGVkV0RBQnVuZGxlSWQpIHtcbiAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCB0aGlzLmdldFN0YXR1cygpO1xuICAgIGlmICghc3RhdHVzIHx8ICFzdGF0dXMuYnVpbGQpIHtcbiAgICAgIGxvZy5kZWJ1ZygnV0RBIGlzIGN1cnJlbnRseSBub3QgcnVubmluZy4gVGhlcmUgaXMgbm90aGluZyB0byBjYWNoZScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyLFxuICAgICAgdXBncmFkZWRBdCxcbiAgICB9ID0gc3RhdHVzLmJ1aWxkO1xuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyKSAmJiB1dGlsLmhhc1ZhbHVlKHVwZGF0ZWRXREFCdW5kbGVJZCkgJiYgdXBkYXRlZFdEQUJ1bmRsZUlkICE9PSBwcm9kdWN0QnVuZGxlSWRlbnRpZmllcikge1xuICAgICAgbG9nLmluZm8oYFdpbGwgdW5pbnN0YWxsIHJ1bm5pbmcgV0RBIHNpbmNlIGl0IGhhcyBkaWZmZXJlbnQgYnVuZGxlIGlkLiBUaGUgYWN0dWFsIHZhbHVlIGlzICcke3Byb2R1Y3RCdW5kbGVJZGVudGlmaWVyfScuYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgICB9XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUocHJvZHVjdEJ1bmRsZUlkZW50aWZpZXIpICYmICF1dGlsLmhhc1ZhbHVlKHVwZGF0ZWRXREFCdW5kbGVJZCkgJiYgV0RBX1JVTk5FUl9CVU5ETEVfSUQgIT09IHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyKSB7XG4gICAgICBsb2cuaW5mbyhgV2lsbCB1bmluc3RhbGwgcnVubmluZyBXREEgc2luY2UgaXRzIGJ1bmRsZSBpZCBpcyBub3QgZXF1YWwgdG8gdGhlIGRlZmF1bHQgdmFsdWUgJHtXREFfUlVOTkVSX0JVTkRMRV9JRH1gKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVuaW5zdGFsbCgpO1xuICAgIH1cblxuICAgIGNvbnN0IGFjdHVhbFVwZ3JhZGVUaW1lc3RhbXAgPSBhd2FpdCBnZXRXREFVcGdyYWRlVGltZXN0YW1wKHRoaXMuYm9vdHN0cmFwUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBVcGdyYWRlIHRpbWVzdGFtcCBvZiB0aGUgY3VycmVudGx5IGJ1bmRsZWQgV0RBOiAke2FjdHVhbFVwZ3JhZGVUaW1lc3RhbXB9YCk7XG4gICAgbG9nLmRlYnVnKGBVcGdyYWRlIHRpbWVzdGFtcCBvZiB0aGUgV0RBIG9uIHRoZSBkZXZpY2U6ICR7dXBncmFkZWRBdH1gKTtcbiAgICBpZiAoYWN0dWFsVXBncmFkZVRpbWVzdGFtcCAmJiB1cGdyYWRlZEF0ICYmIF8udG9Mb3dlcihgJHthY3R1YWxVcGdyYWRlVGltZXN0YW1wfWApICE9PSBfLnRvTG93ZXIoYCR7dXBncmFkZWRBdH1gKSkge1xuICAgICAgbG9nLmluZm8oJ1dpbGwgdW5pbnN0YWxsIHJ1bm5pbmcgV0RBIHNpbmNlIGl0IGhhcyBkaWZmZXJlbnQgdmVyc2lvbiBpbiBjb21wYXJpc29uIHRvIHRoZSBvbmUgJyArXG4gICAgICAgIGB3aGljaCBpcyBidW5kbGVkIHdpdGggYXBwaXVtLXhjdWl0ZXN0LWRyaXZlciBtb2R1bGUgKCR7YWN0dWFsVXBncmFkZVRpbWVzdGFtcH0gIT0gJHt1cGdyYWRlZEF0fSlgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVuaW5zdGFsbCgpO1xuICAgIH1cblxuICAgIGNvbnN0IG1lc3NhZ2UgPSB1dGlsLmhhc1ZhbHVlKHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyKVxuICAgICAgPyBgV2lsbCByZXVzZSBwcmV2aW91c2x5IGNhY2hlZCBXREEgaW5zdGFuY2UgYXQgJyR7dGhpcy51cmwuaHJlZn0nIHdpdGggJyR7cHJvZHVjdEJ1bmRsZUlkZW50aWZpZXJ9J2BcbiAgICAgIDogYFdpbGwgcmV1c2UgcHJldmlvdXNseSBjYWNoZWQgV0RBIGluc3RhbmNlIGF0ICcke3RoaXMudXJsLmhyZWZ9J2A7XG4gICAgbG9nLmluZm8oYCR7bWVzc2FnZX0uIFNldCB0aGUgd2RhTG9jYWxQb3J0IGNhcGFiaWxpdHkgdG8gYSB2YWx1ZSBkaWZmZXJlbnQgZnJvbSAke3RoaXMudXJsLnBvcnR9IGlmIHRoaXMgaXMgYW4gdW5kZXNpcmVkIGJlaGF2aW9yLmApO1xuICAgIHRoaXMud2ViRHJpdmVyQWdlbnRVcmwgPSB0aGlzLnVybC5ocmVmO1xuICB9XG5cbiAgYXN5bmMgcXVpdEFuZFVuaW5zdGFsbCAoKSB7XG4gICAgYXdhaXQgdGhpcy5xdWl0KCk7XG4gICAgYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBXZWJEcml2ZXJBZ2VudDtcbmV4cG9ydCB7IFdlYkRyaXZlckFnZW50LCBXREFfQlVORExFX0lELCBCT09UU1RSQVBfUEFUSCwgV0RBX0JBU0VfVVJMIH07XG4iXSwiZmlsZSI6ImxpYi93ZGEvd2ViZHJpdmVyYWdlbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
